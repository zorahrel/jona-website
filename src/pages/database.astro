---
import Layout from "../layouts/Layout.astro";
import databaseData from "../data/database.json";

const databaseItems = databaseData.map((item, index) => ({
  ...item,
  id: index,
  dateLabel: item.date ?? "—",
  evidenceFlag: Boolean(item.evidence),
  fullText: [
    item.title,
    item.what,
    item.format,
    item.note,
    item.keywords,
    item.otherNotes,
    item.date,
  ]
    .filter(Boolean)
    .join(" ")
    .toLowerCase(),
}));

const whatOptions = [
  ...new Set(
    databaseItems
      .map((item) => item.what)
      .filter((value): value is string => Boolean(value))
  ),
].sort((a, b) => a.localeCompare(b));

const formatOptions = [
  ...new Set(
    databaseItems
      .map((item) => item.format)
      .filter((value): value is string => Boolean(value))
  ),
].sort((a, b) => a.localeCompare(b));
---

<Layout title="Database - Design for the Continuum" activePage="database">
  <!-- Hero Section -->
  <section class="px-6 lg:px-24 py-12 lg:py-16">
    <h1 class="font-black text-5xl lg:text-[80px] leading-[0.95] mb-4">
      Database
    </h1>
    <p class="text-base lg:text-lg font-semibold max-w-[600px] opacity-70">
      A collection of practices, references, methodologies, and resources.
    </p>
  </section>

  <!-- Filter Section -->
  <section
    class="px-6 lg:px-24 py-5 border-b-2 border-charcoal sticky top-[52px] bg-cream z-20"
  >
    <div class="filter-bar">
      <input
        id="search-input"
        type="search"
        placeholder="Cerca titoli, note, keywords…"
        class="filter-input"
      />

      <select id="what-filter" class="filter-select">
        <option value="all">Tutte le categorie</option>
        {whatOptions.map((opt) => <option value={opt}>{opt}</option>)}
      </select>

      <select id="format-filter" class="filter-select">
        <option value="all">Tutti i formati</option>
        {formatOptions.map((opt) => <option value={opt}>{opt}</option>)}
      </select>

      <label class="filter-checkbox">
        <input id="evidence-toggle" type="checkbox" class="accent-charcoal" />
        Solo evidenze
      </label>

      <button id="clear-filters" class="filter-reset" type="button">
        Reset
      </button>
    </div>
  </section>

  <!-- Database Rows -->
  <section>
    <div
      id="database-list"
      class="divide-y divide-charcoal border-t border-charcoal"
    >
      {
        databaseItems.map((item) => {
          return (
            <article
              data-row
              data-what={item.what || ""}
              data-format={item.format || ""}
              data-evidence={item.evidenceFlag}
              data-fulltext={item.fullText}
              data-open="false"
              class="database-row group block py-5 lg:py-6 px-6 lg:px-24 hover:bg-charcoal/5 transition-colors"
            >
              <div class="flex flex-col gap-3 lg:gap-4">
                <div class="flex flex-col lg:flex-row lg:items-center gap-3 lg:gap-6">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 flex-wrap">
                      {item.evidenceFlag && (
                        <span class="chip chip-accent">Evidence</span>
                      )}
                      {item.what && (
                        <span class="chip chip-dark">{item.what}</span>
                      )}
                      {item.format && (
                        <span class="chip chip-outline">{item.format}</span>
                      )}
                    </div>

                    <h3 class="font-black text-lg lg:text-xl leading-tight mt-2">
                      {item.title}
                    </h3>
                    <p class="text-sm lg:text-base font-semibold leading-relaxed opacity-80 mt-1 line-clamp summary-note">
                      {item.note || "—"}
                    </p>
                  </div>

                  <div class="lg:w-[120px] shrink-0 text-sm font-semibold opacity-70">
                    {item.dateLabel}
                  </div>

                  <div class="lg:w-[200px] shrink-0 flex flex-wrap gap-2 justify-start lg:justify-end">
                    {item.link && (
                      <a
                        href={item.link}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="chip chip-ghost text-xs font-bold border border-charcoal/50 hover:bg-charcoal hover:text-cream transition-colors"
                      >
                        Apri link
                      </a>
                    )}
                    <button
                      type="button"
                      class="chip chip-dark text-xs font-bold toggle-btn"
                      data-toggle
                    >
                      <span class="chevron" aria-hidden="true">
                        ›
                      </span>
                      <span class="toggle-label">Espandi</span>
                    </button>
                  </div>
                </div>

                <div class="detail-panel hidden" data-detail>
                  <div class="grid gap-4 lg:grid-cols-3">
                    <div class="lg:col-span-2">
                      <div class="label">Note</div>
                      <p class="text-sm lg:text-base font-semibold leading-relaxed opacity-90 whitespace-pre-line">
                        {item.note || "—"}
                      </p>
                    </div>
                    <div>
                      <div class="label">Keywords</div>
                      <p class="text-sm leading-relaxed whitespace-pre-line opacity-80">
                        {item.keywords || "—"}
                      </p>
                    </div>
                  </div>

                  {item.otherNotes && (
                    <div class="mt-3 border border-dashed border-charcoal/30 p-3 text-sm opacity-90 bg-white">
                      <div class="label">Other notes</div>
                      <p class="leading-relaxed whitespace-pre-line">
                        {item.otherNotes}
                      </p>
                    </div>
                  )}
                </div>
              </div>
            </article>
          );
        })
      }
    </div>
  </section>

  <!-- Count -->
  <section class="px-6 lg:px-24 py-8 pb-32">
    <p class="text-sm font-semibold opacity-50">
      <span id="count">{databaseItems.length}</span> resources
    </p>
  </section>
</Layout>

<style>
  .filter-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
    align-items: center;
  }

  .filter-input,
  .filter-select,
  .filter-reset {
    height: 44px;
    border: 1px solid rgba(17, 17, 17, 0.25);
    background: #fff;
    padding: 0 14px;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.01em;
    border-radius: 6px;
    transition:
      border-color 0.15s ease,
      box-shadow 0.15s ease;
  }

  .filter-input:focus,
  .filter-select:focus {
    outline: none;
    border-color: var(--charcoal, #111);
    box-shadow: 0 0 0 2px rgba(17, 17, 17, 0.08);
  }

  .filter-checkbox {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    height: 44px;
    padding: 0 14px;
    border: 1px solid rgba(17, 17, 17, 0.25);
    border-radius: 6px;
    background: #fff;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.02em;
  }

  .filter-reset {
    background: rgba(17, 17, 17, 0.04);
    cursor: pointer;
  }

  .filter-reset:hover {
    background: var(--charcoal, #111);
    color: var(--cream, #f9f6ef);
  }

  .filter-reset:focus {
    outline: none;
    border-color: var(--charcoal, #111);
  }

  .chip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 32px;
    padding: 0 12px;
    border-radius: 9999px;
    font-size: 11px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    font-weight: 700;
    line-height: 1;
    gap: 6px;
  }

  .chip-dark {
    background: var(--charcoal, #111);
    color: var(--cream, #f9f6ef);
  }

  .chip-outline {
    border: 1px solid rgba(17, 17, 17, 0.3);
    color: var(--charcoal, #111);
    background: rgba(17, 17, 17, 0.03);
  }

  .chip-accent {
    background: var(--pink, #ff4d79);
    color: var(--charcoal, #111);
  }

  .chip-ghost {
    background: rgba(17, 17, 17, 0.03);
    color: var(--charcoal, #111);
  }

  .line-clamp {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .detail-panel {
    border-top: 1px solid rgba(17, 17, 17, 0.1);
    padding-top: 14px;
  }

  .label {
    font-size: 11px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    font-weight: 700;
    opacity: 0.6;
    margin-bottom: 6px;
  }

  .database-row[data-open="true"] {
    background: linear-gradient(
      120deg,
      rgba(255, 77, 121, 0.06),
      rgba(17, 17, 17, 0.02)
    );
    border-left: 4px solid var(--pink, #ff4d79);
    padding-left: calc(1.5rem - 4px);
  }

  .database-row[data-open="true"] .detail-panel {
    display: block;
  }
  .database-row[data-open="false"] .detail-panel {
    display: none;
  }

  .database-row[data-open="true"] .summary-note {
    display: none;
  }

  .toggle-btn .chevron {
    display: inline-block;
    transition: transform 0.2s ease;
    font-size: 14px;
    line-height: 1;
  }

  .database-row[data-open="true"] .toggle-btn .chevron {
    transform: rotate(90deg);
  }
</style>

<script>
  // @ts-nocheck
  /** @type {HTMLInputElement | null} */
  const searchInput = document.getElementById("search-input");
  /** @type {HTMLSelectElement | null} */
  const whatFilter = document.getElementById("what-filter");
  /** @type {HTMLSelectElement | null} */
  const formatFilter = document.getElementById("format-filter");
  /** @type {HTMLInputElement | null} */
  const evidenceToggle = document.getElementById("evidence-toggle");
  /** @type {HTMLButtonElement | null} */
  const clearFilters = document.getElementById("clear-filters");
  /** @type {HTMLElement[]} */
  const rows = Array.from(document.querySelectorAll("[data-row]"));
  const toggles = Array.from(document.querySelectorAll("[data-toggle]"));
  const countEl = document.getElementById("count");

  const readValue = (el) => (el?.value ? String(el.value) : "");
  const readChecked = (el) => Boolean(el?.checked);

  const applyFilters = () => {
    const term = readValue(searchInput).trim().toLowerCase();
    const what = readValue(whatFilter) || "all";
    const format = readValue(formatFilter) || "all";
    const evidenceOnly = readChecked(evidenceToggle);

    let visible = 0;

    rows.forEach((row) => {
      if (!(row instanceof HTMLElement)) return;
      const rowWhat = row.dataset.what || "";
      const rowFormat = row.dataset.format || "";
      const rowEvidence = row.dataset.evidence === "true";
      const text = row.dataset.fulltext || "";

      const matchesSearch = !term || text.includes(term);
      const matchesWhat = what === "all" || rowWhat === what;
      const matchesFormat = format === "all" || rowFormat === format;
      const matchesEvidence = !evidenceOnly || rowEvidence;

      const show =
        matchesSearch && matchesWhat && matchesFormat && matchesEvidence;
      row.style.display = show ? "block" : "none";
      if (show) visible++;
    });

    if (countEl) countEl.textContent = String(visible);
  };

  searchInput?.addEventListener("input", applyFilters);
  whatFilter?.addEventListener("change", applyFilters);
  formatFilter?.addEventListener("change", applyFilters);
  evidenceToggle?.addEventListener("change", applyFilters);

  clearFilters?.addEventListener("click", () => {
    if (searchInput) searchInput.value = "";
    if (whatFilter) whatFilter.value = "all";
    if (formatFilter) formatFilter.value = "all";
    if (evidenceToggle) evidenceToggle.checked = false;
    applyFilters();
  });

  toggles.forEach((btn) => {
    btn.addEventListener("click", () => {
      const row = btn.closest("[data-row]");
      if (!row) return;
      const isOpen = row.getAttribute("data-open") === "true";
      row.setAttribute("data-open", isOpen ? "false" : "true");
      const label = btn.querySelector(".toggle-label");
      if (label) label.textContent = isOpen ? "Espandi" : "Chiudi";
    });
  });

  applyFilters();
</script>
